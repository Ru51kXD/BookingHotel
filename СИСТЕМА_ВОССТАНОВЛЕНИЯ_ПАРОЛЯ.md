# Система восстановления пароля

## Обзор

Добавлена полная система восстановления пароля с двухфакторной аутентификацией по email и последним цифрам номера телефона.

## Как это работает

### 1. Инициация восстановления
- Пользователь нажимает "Забыли пароль?" в форме входа
- Открывается модальное окно восстановления пароля

### 2. Проверка личности (Шаг 1)
Пользователь вводит:
- **Email адрес** - точный email аккаунта
- **Последние 4 цифры номера телефона** - для подтверждения личности

### 3. Установка нового пароля (Шаг 2)
После успешной проверки:
- Ввод нового пароля (минимум 6 символов)
- Подтверждение нового пароля
- Сохранение изменений

### 4. Успешное завершение (Шаг 3)
- Подтверждение изменения пароля
- Возможность сразу войти с новым паролем

## Поддерживаемые аккаунты

### Встроенные аккаунты

#### Администратор
- **Email:** `admin@rulit.com`
- **Код восстановления:** `2025`
- **Примечание:** У админа нет номера телефона, поэтому используется специальный код

#### Демо пользователь
- **Email:** `demo@example.com`
- **Код восстановления:** `1234`
- **Примечание:** Последние 4 цифры условного номера телефона

### Зарегистрированные пользователи
- Для всех пользователей, зарегистрированных через форму регистрации
- Используются реальные последние 4 цифры указанного при регистрации номера телефона
- Данные хранятся в `localStorage` под ключом `registered_users`

## Технические детали

### Компоненты

#### ForgotPasswordModal.tsx
- Основной компонент модального окна
- Трехэтапный процесс с анимациями
- Валидация данных на каждом шаге
- Индикатор прогресса

#### Обновленная система авторизации (auth.tsx)
Добавлены новые функции:

```typescript
verifyUserForPasswordReset(email: string, phoneLastDigits: string): Promise<{
  success: boolean;
  error?: string;
  userId?: string;
}>

resetPassword(userId: string, newPassword: string): Promise<{
  success: boolean;
  error?: string;
}>
```

### Хранение данных

#### localStorage ключи:
- `registered_users` - массив зарегистрированных пользователей с паролями
- `hotel_user` - текущий авторизованный пользователь

#### Структура пользователя в registered_users:
```json
{
  "id": "1234567890",
  "name": "Имя Пользователя",
  "email": "user@example.com",
  "phone": "+7 777 123 45 67",
  "password": "userpassword",
  "role": "user",
  "created_at": "2024-01-01T00:00:00.000Z",
  "updated_at": "2024-01-01T00:00:00.000Z"
}
```

### Безопасность

#### Проверка данных:
1. **Email** - точное совпадение с зарегистрированным
2. **Номер телефона** - извлекаются только цифры, берутся последние 4
3. **Пароль** - минимум 6 символов, подтверждение совпадения

#### Обработка ошибок:
- Неверные данные для восстановления
- Пользователь не найден
- Ошибки сети/системы
- Валидация пароля

## Использование

### Для тестирования:

1. **Админ аккаунт:**
   ```
   Email: admin@rulit.com
   Код: 2025
   ```

2. **Демо аккаунт:**
   ```
   Email: demo@example.com
   Код: 1234
   ```

3. **Новый пользователь:**
   - Зарегистрируйтесь с номером телефона
   - Используйте последние 4 цифры для восстановления

### Пример восстановления:

1. Откройте форму входа
2. Нажмите "Забыли пароль?"
3. Введите `demo@example.com` и `1234`
4. Нажмите "Подтвердить данные"
5. Введите новый пароль дважды
6. Нажмите "Сохранить новый пароль"
7. Войдите с новым паролем

## Интеграция

### В LoginModal добавлено:
- Кнопка "Забыли пароль?" под полем пароля
- Импорт и использование ForgotPasswordModal
- Состояние showForgotPassword

### Обновленная регистрация:
- Сохранение пользователей с паролями в localStorage
- Проверка на существующий email
- Поддержка номеров телефонов

### Обновленный вход:
- Проверка зарегистрированных пользователей
- Поддержка обновленных паролей

## Анимации и UX

### Визуальные элементы:
- Индикатор прогресса (3 точки)
- Плавные переходы между шагами
- Анимированные иконки для каждого шага
- Цветовая схема: синий → зеленый → зеленый

### Подсказки:
- Примеры ввода данных
- Коды для тестовых аккаунтов
- Требования к паролю
- Объяснение формата номера телефона

## Расширение системы

### Для продакшена:
1. Заменить localStorage на API вызовы
2. Добавить отправку SMS/Email с кодом
3. Добавить капчу для защиты от ботов
4. Логирование попыток восстановления
5. Ограничение количества попыток

### Дополнительные функции:
- Восстановление по SMS
- Двухфакторная аутентификация
- История изменений пароля
- Уведомления о смене пароля

## Тестирование

Система полностью функциональна и готова к тестированию. Все данные сохраняются локально и работают в реальном времени.

**Статус:** ✅ Готово к использованию 